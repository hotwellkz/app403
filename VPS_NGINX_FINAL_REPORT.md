# ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç: Nginx Reverse Proxy –¥–ª—è api.2wix.ru

## üéØ –°—Ç–∞—Ç—É—Å: –ì–û–¢–û–í–û

Reverse proxy –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Synology —á–µ—Ä–µ–∑ VPN —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞

### –ó–∞–Ω—è—Ç—ã–µ –ø–æ—Ä—Ç—ã –Ω–∞ VPS:
- ‚úÖ `80` (HTTP) - nginx
- ‚úÖ `443` (HTTPS) - nginx  
- ‚úÖ –ü–æ—Ä—Ç `3000` –∏ `3001` –ù–ï —Å–ª—É—à–∞—é—Ç –Ω–∞ VPS (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ VPN)

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã (–Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã):
1. **api.playflon.com** ‚Üí `/etc/nginx/sites-enabled/api.playflon.com`
2. **api.shortsai.ru** ‚Üí `/etc/nginx/sites-enabled/api.shortsai.ru`
   - –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ `http://10.8.0.1:3000` (Synology —á–µ—Ä–µ–∑ VPN)

### VPN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- **VPS VPN IP:** `10.8.0.6` (—á–µ—Ä–µ–∑ `tun1`)
- **Synology VPN IP:** `10.8.0.1` (—á–µ—Ä–µ–∑ `tun0`)
- **–ú–∞—Ä—à—Ä—É—Ç:** `10.8.0.0/24` —á–µ—Ä–µ–∑ VPN

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥
**–§–∞–π–ª:** `/etc/nginx/sites-available/api-2wix-whatsapp.conf`

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**
- HTTP server block (–ø–æ—Ä—Ç 80) - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS + ACME challenge
- HTTPS server block (–ø–æ—Ä—Ç 443) - –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ `http://10.8.0.1:3000`

**–õ–æ–∫–∞—Ü–∏–∏:**
- `/socket.io/` - WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è Socket.IO
- `/whatsapp/` - WhatsApp API endpoints  
- `/health` - Health check endpoint
- `/` - Root –∏ –¥—Ä—É–≥–∏–µ API endpoints

### 2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∫–æ–Ω—Ñ–∏–≥
```bash
sudo ln -sf /etc/nginx/sites-available/api-2wix-whatsapp.conf \
            /etc/nginx/sites-enabled/api-2wix-whatsapp.conf
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ reload
```bash
sudo nginx -t
# ‚úÖ nginx: the configuration file /etc/nginx/nginx.conf syntax is ok

sudo systemctl reload nginx
# ‚úÖ Nginx reloaded (–Ω–µ restart - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π downtime)
```

---

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ Health endpoint:
```bash
curl -k https://api.2wix.ru/health
# –û—Ç–≤–µ—Ç: {"ok":true}
# –°—Ç–∞—Ç—É—Å: HTTP/2 200 ‚úÖ
```

### ‚ö†Ô∏è WhatsApp endpoint:
```bash
curl -k https://api.2wix.ru/whatsapp/status
# –û—Ç–≤–µ—Ç: {"error":"Not Found","message":"Route GET /whatsapp/status not found"}
# –°—Ç–∞—Ç—É—Å: HTTP/2 404
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∑–∞–ø—Ä–æ—Å –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞), –Ω–æ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404. –≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ whatsapp-server, –∞ –Ω–µ nginx. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
- –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞
- –†–æ—É—Ç –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –°–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä `/api/whatsapp/status`)

### ‚ö†Ô∏è Socket.IO endpoint:
```bash
curl -k 'https://api.2wix.ru/socket.io/?EIO=4&transport=polling'
# –û—Ç–≤–µ—Ç: {"error":"Not Found","message":"Route GET /socket.io/ not found"}
# –°—Ç–∞—Ç—É—Å: HTTP/2 404
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ - –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ä–æ—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

---

## üìù –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. ‚úÖ `/etc/nginx/sites-available/api-2wix-whatsapp.conf` (–Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥)
2. ‚úÖ `/etc/nginx/sites-enabled/api-2wix-whatsapp.conf` (symlink)

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚ùå **–ù–ï–¢** - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥–∏ –Ω–µ –∏–∑–º–µ–Ω—è–ª–∏—Å—å

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
- ‚úÖ `nginx` - reloaded (–Ω–µ restarted)
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã (`api.playflon.com`, `api.shortsai.ru`) - **–Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã**

---

## üîí SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SSL (Let's Encrypt):**
```bash
ssh shortsai-vps
sudo certbot --nginx -d api.2wix.ru
```

**–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- –û–±–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ñ–∏–≥ —Å –ø—É—Ç—è–º–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º
- –ù–∞—Å—Ç—Ä–æ–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –í–∫–ª—é—á–∏—Ç HTTPS —Å –≤–∞–ª–∏–¥–Ω—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°–µ–π—á–∞—Å HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –±—Ä–∞—É–∑–µ—Ä—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ. –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ certbot —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—Å—è.

---

## üîç Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: 404 –Ω–∞ `/whatsapp/status`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä whatsapp-server –∑–∞–ø—É—â–µ–Ω:
   ```bash
   ssh admin@192.168.100.222
   sudo docker ps | grep whatsapp-server
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
   ```bash
   sudo docker logs whatsapp-server | tail -50
   ```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
   ```bash
   cd /volume1/docker/whatsapp-server
   sudo /usr/local/bin/docker compose -f docker-compose.synology.yml restart
   ```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ä–æ—É—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ–¥–µ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `app.get('/whatsapp/status', ...)`)

### –ü—Ä–æ–±–ª–µ–º–∞: 502 Bad Gateway

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Synology:
   ```bash
   ssh shortsai-vps
   curl http://10.8.0.1:3000/health
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ nginx:
   ```bash
   sudo tail -50 /var/log/nginx/api-2wix-error.log
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ –µ—Å—Ç—å `proxy_set_header Upgrade $http_upgrade;`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 300s)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ nginx –Ω–∞ –æ—à–∏–±–∫–∏ WebSocket

---

## üìã –ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Internet
   ‚Üì
api.2wix.ru (DNS ‚Üí VPS IP: 159.255.37.158)
   ‚Üì
Nginx –Ω–∞ VPS (–ø–æ—Ä—Ç 443)
   ‚Üì
VPN —Ç—É–Ω–Ω–µ–ª—å (10.8.0.0/24)
   ‚Üì
Synology (10.8.0.1:3000)
   ‚Üì
Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä whatsapp-server
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã
2. ‚úÖ –ü–æ—Ä—Ç 3000/3001 –Ω–∞ VPS –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
3. ‚úÖ –ù–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª)
4. ‚úÖ Nginx reload (–Ω–µ restart) - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π downtime
5. ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω (`nginx -t`)

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:**
   ```bash
   ssh shortsai-vps
   sudo certbot --nginx -d api.2wix.ru
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–æ—É—Ç—ã –Ω–∞ whatsapp-server:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–æ—É—Ç—ã `/whatsapp/status` –∏ `/socket.io/` –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ https://2wix.ru
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `üîó Backend URL: https://api.2wix.ru`

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   ```bash
   # –õ–æ–≥–∏ nginx
   sudo tail -f /var/log/nginx/api-2wix-access.log
   sudo tail -f /var/log/nginx/api-2wix-error.log
   
   # –õ–æ–≥–∏ whatsapp-server –Ω–∞ Synology
   ssh admin@192.168.100.222
   sudo docker logs -f whatsapp-server
   ```

---

## üìä –†–µ–∑—é–º–µ

‚úÖ **Reverse proxy –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç**
‚úÖ **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã**
‚úÖ **–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Synology —á–µ—Ä–µ–∑ VPN —Ä–∞–±–æ—Ç–∞–µ—Ç**
‚úÖ **HTTP ‚Üí HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç**
‚úÖ **WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞**
‚úÖ **Health endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç**
‚ö†Ô∏è **WhatsApp –∏ Socket.IO endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 404** (–ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–µ nginx)

**–°—Ç–∞—Ç—É—Å:** üü¢ **NGINX –ì–û–¢–û–í, –¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ï–†–ê**

---

**–î–∞—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:** 2026-01-08  
**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** Senior DevOps Engineer
