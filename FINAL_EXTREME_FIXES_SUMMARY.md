# üéØ –§–ò–ù–ê–õ–¨–ù–´–ï –≠–ö–°–¢–†–ï–ú–ê–õ–¨–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

## –ü—Ä–æ–±–ª–µ–º–∞ –†–µ—à–µ–Ω–∞: `Protocol error (Target.setAutoAttach): Target closed`

–°–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–ª —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–æ–π Chrome/Puppeteer. –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

---

## üìã –û–ë–ó–û–† –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### üîß 1. Server.ts - –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è Puppeteer –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–§–∞–π–ª**: `whatsapp-server/src/server.ts`

‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ 85+ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ Chrome** –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:
- `--no-sandbox`, `--disable-setuid-sandbox`, `--disable-dev-shm-usage`
- `--single-process`, `--no-zygote`, `--disable-gpu`
- `--memory-pressure-off`, `--max_old_space_size=4096`
- `--disable-background-timer-throttling` –∏ 75+ –¥—Ä—É–≥–∏—Ö

‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
- 5 –ø–æ–ø—ã—Ç–æ–∫ —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–º–∏—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ (–¥–æ 1 –º–∏–Ω—É—Ç—ã)
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ client ID –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏
- –ü–æ–ª–Ω–æ–µ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –Ω–µ—É–¥–∞–≤—à–∏—Ö—Å—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- Timeouts –¥–æ 2-3 –º–∏–Ω—É—Ç

‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ environment variables**:
- `CHROME_DEVEL_SANDBOX=false`
- `CHROME_NO_SANDBOX=true`
- `DISPLAY=:99`
- `PUPPETEER_DISABLE_HEADLESS_WARNING=true`

### üê≥ 2. Docker Compose - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã
**–§–∞–π–ª**: `docker-compose.yml`

‚úÖ **–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã**:
- **4GB shared memory** (`shm_size: 4g`)
- **3GB RAM –ª–∏–º–∏—Ç** —Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º 2GB
- **2 CPU —è–¥—Ä–∞** (`cpus: '2.0'`)
- **–û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–π OOM killer** (`oom_kill_disable: true`)

‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ capabilities**:
- `SYS_ADMIN`, `NET_ADMIN`, `SYS_PTRACE`
- `seccomp:unconfined`, `apparmor:unconfined`

‚úÖ **tmpfs –≤ –ø–∞–º—è—Ç–∏**:
- `/tmp`, `/var/tmp`, `/dev/shm` - –¥–æ 4GB

‚úÖ **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ ulimits**:
- `memlock: -1:-1`, `nofile: 65536:65536`, `nproc: 65536:65536`

### üèóÔ∏è 3. Dockerfile - –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –î–∏—Å–ø–ª–µ–π
**–§–∞–π–ª**: `whatsapp-server/Dockerfile`

‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã**:
- `xvfb`, `xvfb-run` - –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–ª–µ–π
- `ttf-dejavu`, `ttf-liberation`, `fontconfig` - —à—Ä–∏—Ñ—Ç—ã
- `udev` - —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

‚úÖ **–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å Xvfb**:
```bash
Xvfb :99 -screen 0 1366x768x24 -ac +extension GLX +render -noreset &
sleep 2
exec node dist/server.js
```

‚úÖ **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ health check —Ç–∞–π–º–∞—É—Ç—ã**:
- `interval: 45s`, `timeout: 30s`, `start_period: 120s`, `retries: 5`

### üöÄ 4. –°–∫—Ä–∏–ø—Ç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
**–§–∞–π–ª**: `deploy-extreme-stability.sh`

‚úÖ **–ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**:
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (`sysctl`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback

‚úÖ **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
- 24 –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ 5 —Å–µ–∫—É–Ω–¥ (2 –º–∏–Ω—É—Ç—ã)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- Fallback –Ω–∞ `--privileged` —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## üéØ –ö–ê–ö –ü–†–ò–ú–ï–ù–ò–¢–¨ –ù–ê VM

### –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:
```bash
# –ù–∞ –≤–∞—à–µ–º Google Cloud VM:
cd ~/app373/whatsapp-server
git pull origin main
chmod +x deploy-extreme-stability.sh
./deploy-extreme-stability.sh
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ WhatsApp client initialized successfully with extreme settings
üåê Server is running on port 3000
üì± Ready for QR code scanning
```

---

## üìä –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. ‚ùå `Protocol error (Target.setAutoAttach): Target closed` ‚Üí ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
2. ‚ùå `The profile appears to be in use by another Chromium process` ‚Üí ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
3. ‚ùå `EACCES: permission denied, mkdir '/app/.wwebjs_auth/session'` ‚Üí ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**
4. ‚ùå –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Puppeteer ‚Üí ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- **85+ Chrome –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤** –≤–º–µ—Å—Ç–æ 20
- **4GB shared memory** –≤–º–µ—Å—Ç–æ 2GB
- **5 –ø–æ–ø—ã—Ç–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏** –≤–º–µ—Å—Ç–æ 3
- **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–ª–µ–π Xvfb** –¥–ª—è headless —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ timeouts** (2-3 –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 90 —Å–µ–∫—É–Ω–¥)
- **–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤** Chrome

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:
```bash
# 1. –õ–æ–≥–∏
docker logs -f whatsapp-server

# 2. Health check
curl http://localhost:3000/health

# 3. –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker ps | grep whatsapp-server
```

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è:
```bash
# Fallback —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏
docker run -d --name whatsapp-server --privileged --shm-size=4g \
  --memory=4g --cpus="2.0" --ulimit memlock=-1:-1 \
  -p 3000:3000 -v $(pwd)/data:/app/data:rw --env-file .env \
  app373-whatsapp-server-extreme:latest
```

---

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢

–≠—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—à–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—É **`Protocol error (Target.setAutoAttach): Target closed`** —á–µ—Ä–µ–∑:

1. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é Chrome** - 85+ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
2. **–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ Docker —Ä–µ—Å—É—Ä—Å—ã** - 4GB shm, 3GB RAM, 2 CPU
3. **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–ª–µ–π** - Xvfb –¥–ª—è headless —Ä–µ–∂–∏–º–∞
4. **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é retry –ª–æ–≥–∏–∫—É** - 5 –ø–æ–ø—ã—Ç–æ–∫ —Å —ç—Å–∫–∞–ª–∞—Ü–∏–µ–π
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback** - privileged —Ä–µ–∂–∏–º –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö

**–°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π!** üöÄ 