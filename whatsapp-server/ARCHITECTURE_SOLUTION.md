# Архитектурное решение проблемы блокировки WhatsApp CDN

## Краткий вывод

**Проблема:** Windows системные фильтры (Network Protection, SmartScreen, DNS фильтрация) блокируют запросы к критичным доменам WhatsApp (`web.whatsapp.com`, `g.whatsapp.net`) на уровне операционной системы, до того как они достигают браузера. Флаг `--disable-web-security` не помогает, так как блокировка происходит на уровне WFP (Windows Filtering Platform) или DNS, а не в браузере.

**Решение:** Изолировать WhatsApp интеграцию в Docker-контейнер или на отдельный сервер, где системные фильтры Windows не применяются. Это production-ready подход, который также улучшает безопасность и масштабируемость.

---

## Почему возникает BLOCKED

### 1. Системная блокировка, не браузерная

Блокировка происходит на уровне:
- **Windows Filtering Platform (WFP)** - фильтрует сетевой трафик до браузера
- **DNS фильтрация** - роутер/провайдер/Windows блокирует резолвинг доменов
- **Network Protection** - Windows Defender блокирует "подозрительные" домены
- **SmartScreen** - блокирует запросы к неизвестным CDN

### 2. Почему `--disable-web-security` не помогает

`--disable-web-security` отключает только CORS и некоторые политики безопасности браузера, но:
- **НЕ влияет** на системные сетевые фильтры (WFP)
- **НЕ влияет** на DNS фильтрацию
- **НЕ влияет** на Windows Defender Network Protection
- **НЕ влияет** на блокировку на уровне роутера

Блокировка происходит **до** того, как запрос попадает в браузер.

### 3. Разница между критичными и некритичными доменами

- **Критичные домены** (`web.whatsapp.com`, `g.whatsapp.net`): необходимы для достижения состояния READY
- **Media CDN** (`media-*.cdn.whatsapp.net`): используются только для загрузки медиа, не критичны для READY

**Решение в коде:** Игнорируем блокировки media CDN и DELETE запросы (нормальная очистка кэша), блокируем сессию только при блокировке критичных доменов.

---

## Архитектурное решение

### Вариант A: Docker изоляция (РЕКОМЕНДУЕТСЯ)

**Преимущества:**
- Полная изоляция от системных фильтров Windows
- Легко развертывать и масштабировать
- Production-ready
- Не требует изменения системных настроек

**Реализация:**

```bash
# Запуск в Docker
cd whatsapp-server
docker-compose up -d

# Или через npm
npm run docker:start
```

**Конфигурация:** Уже настроена в `docker-compose.yml` и `Dockerfile`

### Вариант B: Отдельный Node.js сервис на VPS/Linux

**Преимущества:**
- Полная изоляция от Windows
- Можно использовать на отдельном сервере
- Легко масштабировать

**Недостатки:**
- Требует отдельный сервер/VPS
- Дополнительные расходы

---

## Изменения в коде

### 1. Улучшенная логика блокировки (`whatsapp-server/src/server.ts`)

**До:**
- Любой `ERR_ABORTED` на WhatsApp домене → блокировка
- DELETE к media CDN → блокировка
- Один запрос → блокировка

**После:**
- Разделение критичных (`web.whatsapp.com`) и некритичных (media CDN) доменов
- Игнорирование DELETE к media CDN (нормальная очистка кэша)
- Пороговая логика: минимум 2 критичных блокировки для установки флага
- Media CDN блокировки не блокируют сессию (не критичны для READY)

**Ключевые изменения:**
```typescript
// Счетчики для защиты от ложных срабатываний
let criticalBlockedCount = 0; // Критичные домены
let mediaBlockedCount = 0; // Media CDN
const CRITICAL_BLOCK_THRESHOLD = 2; // Минимум 2 критичных блокировки
const MEDIA_BLOCK_IGNORE_THRESHOLD = 5; // Игнорируем до 5 блокировок media CDN

// Игнорируем DELETE к media CDN
if (isDeleteToMedia) {
    console.log(`Ignoring DELETE to media CDN (normal cache cleanup): ${url}`);
    return;
}

// Блокируем только критичные домены после порога
if (isCriticalDomain && criticalBlockedCount >= CRITICAL_BLOCK_THRESHOLD) {
    isBlocked = true;
    // ...
}
```

### 2. Улучшенная обработка состояний на фронте

**До:**
- `AUTHENTICATED` = "Подключение..." (неясно)
- `BLOCKED` = общее сообщение без контекста

**После:**
- `AUTHENTICATED` = "Аутентификация успешна. Ожидаем готовности WhatsApp... (до 90 секунд)"
- `BLOCKED` = детальное объяснение системной проблемы + рекомендации

### 3. Docker изоляция

**Улучшения:**
- Добавлены переменные окружения для изоляции
- Увеличен таймаут READY до 90 секунд
- Настроена сетевая изоляция

---

## Рекомендация для production

### ✅ ИСПОЛЬЗУЙТЕ Docker

1. **Запуск:**
```bash
cd whatsapp-server
docker-compose up -d
```

2. **Проверка:**
```bash
docker logs whatsapp-server
```

3. **Остановка:**
```bash
docker-compose down
```

### ✅ НЕ делайте в production:

- ❌ Отключать Windows Defender Network Protection
- ❌ Отключать SmartScreen
- ❌ Изменять системные DNS настройки
- ❌ Использовать `--disable-web-security` (не помогает)
- ❌ Добавлять исключения в hosts файл
- ❌ Использовать iframe/WebView обходы

### ✅ Делайте в production:

- ✅ Используйте Docker для изоляции
- ✅ Разделяйте критичные и некритичные домены в логике
- ✅ Используйте пороговую логику для блокировок
- ✅ Логируйте все блокировки для диагностики
- ✅ Показывайте понятные сообщения об ошибках пользователям

---

## Чеклист антипаттернов

### ❌ НЕ делайте:

1. **Не пытайтесь "чинить" через Puppeteer флаги**
   - `--disable-web-security` не помогает
   - Проблема системная, не браузерная

2. **Не отключайте защиту Windows в production**
   - `Set-MpPreference -DisableNetworkProtection $true` - только для диагностики
   - В production используйте Docker

3. **Не используйте iframe/WebView обходы**
   - Нестабильно
   - Не решает проблему

4. **Не блокируйте сессию при блокировке media CDN**
   - Media CDN не критичен для READY
   - DELETE к media CDN - нормальная операция

5. **Не устанавливайте флаг блокировки при первой ошибке**
   - Используйте пороговую логику
   - Разделяйте критичные и некритичные домены

---

## Проверка решения

### 1. Запуск в Docker:
```bash
cd whatsapp-server
docker-compose up -d
docker logs -f whatsapp-server
```

### 2. Проверка логов:
- ✅ Нет `ERR_ABORTED` на критичных доменах
- ✅ `AUTHENTICATED` → `READY` за 30-90 секунд
- ✅ Media CDN блокировки игнорируются

### 3. Проверка UI:
- ✅ `AUTHENTICATED` показывает понятное сообщение
- ✅ `BLOCKED` показывает детальное объяснение
- ✅ Нет бесконечного "Подключение..."

---

## Итог

**Проблема:** Системная блокировка Windows, не браузерная.

**Решение:** Docker изоляция + улучшенная логика блокировки.

**Результат:** Стабильная работа WhatsApp интеграции без изменения системных настроек Windows.
