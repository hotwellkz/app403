# üö® –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ Service Worker –∏ —Å–µ—Ç–µ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## üìã –ü—Ä–æ–±–ª–µ–º—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. **Service Worker –æ—à–∏–±–∫–∏**
```
‚ùå TypeError: Failed to convert value to 'Response'
‚ùå TypeError: Failed to execute 'put' on 'Cache': Request scheme 'chrome-extension' is unsupported
‚ùå The FetchEvent resulted in a network error response
```

### 2. **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏**  
```
‚ùå WebSocket connection failed
‚ùå Failed to load resource: net::ERR_FAILED
‚ùå 503 Service Unavailable (WhatsApp client not ready)
```

## ‚úÖ –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### üîß Service Worker (`public/sw.js`)

**–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ö–µ–º URL:**
```javascript
const isSupportedScheme = (url) => {
  try {
    const urlObj = new URL(url);
    return urlObj.protocol === 'http:' || urlObj.protocol === 'https:' || urlObj.protocol === '';
  } catch (error) {
    return false;
  }
};
```

**–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞:**
```javascript
if (url.protocol === 'chrome-extension:' || 
    url.protocol === 'moz-extension:' || 
    url.protocol === 'safari-extension:') {
  return; // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
}
```

**–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Response –æ–±—ä–µ–∫—Ç–æ–≤:**
```javascript
const createErrorResponse = (status = 500) => {
  return new Response('Service Worker Error', {
    status: status,
    statusText: 'Service Worker Error',
    headers: new Headers({'Content-Type': 'text/plain'})
  });
};
```

### üåê –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (`src/utils/connectionStabilizer.ts`)

**–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ 503 –æ—à–∏–±–æ–∫:**
```typescript
// –ù–ï –ø–æ–≤—Ç–æ—Ä—è–µ–º 503 –æ—à–∏–±–∫–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
if (error.response?.status === 503) {
  return false; // –ü—É—Å—Ç—å health check –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
}
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```typescript
// 15 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ 503, 5 —Å–µ–∫—É–Ω–¥ –æ–±—ã—á–Ω–æ
const interval = this.state.is503ErrorActive ? 15000 : 5000;
```

**–ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è 503:**
```typescript
interface ConnectionState {
  is503ErrorActive: boolean; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
  // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
}
```

### üì± –£–ª—É—á—à–µ–Ω–Ω—ã–π UI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (`src/components/ConnectionStatusIndicator.tsx`)

**–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è 503 –æ—à–∏–±–æ–∫:**
```typescript
if (connectionState.is503ErrorActive) {
  return {
    status: 'service-unavailable',
    text: '–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
    icon: MdPause,
    color: 'text-orange-600'
  };
}
```

### üõ†Ô∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (`src/lib/serviceWorker.ts`)

**–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã:
swDiagnose()  // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
swDisable()   // –û—Ç–∫–ª—é—á–∏—Ç—å Service Worker
swEnable()    // –í–∫–ª—é—á–∏—Ç—å Service Worker
```

## üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ**
–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```javascript
// –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
swDiagnose()

// –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è, –æ—Ç–∫–ª—é—á–∏—Ç–µ SW
swDisable()

// –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
location.reload()
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**
–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ WhatsApp –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:
- üü¢ **–ü–æ–¥–∫–ª—é—á–µ–Ω–æ** - –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- üü° **–°–µ—Ä–≤–µ—Ä –Ω–µ –≥–æ—Ç–æ–≤** - —Å–µ—Ä–≤–µ—Ä –µ—Å—Ç—å, WhatsApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è  
- üü† **–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** - 503 –æ—à–∏–±–∫–∞, –æ–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- üîµ **–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –∏–¥—É—Ç –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- üî¥ **–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** - –ø–æ–ª–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

### 3. **–†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Service Worker**
```javascript
// –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞ (–¥–æ —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è)
localStorage.setItem('disable-service-worker', 'true');
location.reload();

// –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
localStorage.removeItem('disable-service-worker');
location.reload();
```

### 4. **–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π –±—Ä–∞—É–∑–µ—Ä–∞**
```javascript
// –ß–µ—Ä–µ–∑ DevTools –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
caches.keys().then(names => {
  names.forEach(name => caches.delete(name));
});
```

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –æ—Ç Service Worker
- ‚ùå –ü–æ–ø—ã—Ç–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å chrome-extension –∑–∞–ø—Ä–æ—Å—ã  
- ‚ùå –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ retry –ø—Ä–∏ 503 –æ—à–∏–±–∫–∞—Ö
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ **Service Worker –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å—Ö–µ–º—ã**
- ‚úÖ **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ retry —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫**  
- ‚úÖ **–í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
- ‚úÖ **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ –∫–æ–Ω—Å–æ–ª–∏**
- ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏**

## üìä –õ–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ):**
```
‚úÖ Service Worker installed successfully
üåê –°–µ—Ç—å: OK | üì± WhatsApp: –ù–µ –≥–æ—Ç–æ–≤  
üö´ 503 error - stopping retries, will wait for health check
üîÑ Using fallback for critical operation
```

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ª–æ–≥–∏ (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è):**
```
‚ùå Multiple service worker errors (–Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å SW)
‚ùå Constant network failures (–ø—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º)
‚ùå WhatsApp server completely down (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä)
```

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ WhatsApp
npm run restart-server

# –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫—ç—à–µ–π
npm run clear-cache

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
curl http://localhost:3000/health
```

## üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è

1. **–û—Ç–∫–ª—é—á–∏—Ç–µ Service Worker:** `swDisable()`
2. **–û—á–∏—Å—Ç–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä–∞** –¥–ª—è localhost:5173
3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä** WhatsApp
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**
5. **–û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä** –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤–∞ –∫ —Å–±–æ—è–º –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —á–µ—Ç–∫—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π! 