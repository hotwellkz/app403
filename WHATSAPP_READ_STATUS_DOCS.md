# üìñ –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π WhatsApp

## üéØ **–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É —Å–µ–∞–Ω—Å–∞–º–∏. –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, –∫–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ –±—ã–ª–∏ –ø—Ä–æ—á–∏—Ç–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

## ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**

### üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**
- ‚úÖ **–¢–æ—á–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç** –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ timestamps
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (JSON —Ñ–∞–π–ª)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–º–µ—Ç–∫–∞** —á–∞—Ç–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
- ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** UI –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏** - –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
- ‚úÖ **API endpoints** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ **–ë–∞—Ç—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### üìä **–õ–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞**
```typescript
// –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã
if (!readStatus) {
    // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ - –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    unreadCount = allIncomingMessages.length;
} else {
    // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ lastReadTimestamp
    unreadCount = messagesAfter(readStatus.lastReadTimestamp)
        .filter(msg => !msg.fromMe).length;
}
```

## üõ† **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**

### **–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (Node.js + Express)**

#### **1. –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö**
```typescript
// whatsapp-server/src/types/readStatus.ts
export interface ReadStatus {
    chatId: string; // phoneNumber —á–∞—Ç–∞
    userId?: string; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞)
    lastReadMessageId: string; // ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    lastReadTimestamp: string; // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    updatedAt: string; // –ö–æ–≥–¥–∞ –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å
}

export interface ReadStatusStore {
    [chatId: string]: ReadStatus;
}
```

#### **2. –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö**
```typescript
// whatsapp-server/src/utils/readStatusStorage.ts

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ data/readStatus.json
{
  "79001234567@c.us": {
    "chatId": "79001234567@c.us",
    "lastReadMessageId": "msg_123456789",
    "lastReadTimestamp": "2024-01-15T14:30:00.000Z",
    "updatedAt": "2024-01-15T14:30:05.000Z"
  }
}
```

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:**
- `updateReadStatus()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏
- `calculateUnreadCount()` - –ø–æ–¥—Å—á–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è —á–∞—Ç–∞
- `calculateUnreadCountsForAllChats()` - –ø–æ–¥—Å—á–µ—Ç –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤
- `markChatAsRead()` - –ø–æ–º–µ—Ç–∫–∞ —á–∞—Ç–∞ –∫–∞–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ

#### **3. API Endpoints**

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| `POST` | `/read-status/update` | –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏ |
| `POST` | `/read-status/mark-read/:chatId` | –ü–æ–º–µ—Ç–∏—Ç—å —á–∞—Ç –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π |
| `GET` | `/read-status/:chatId` | –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏ |
| `GET` | `/read-status` | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã |
| `GET` | `/read-status/:chatId/unread-count` | –ü–æ–¥—Å—á–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è —á–∞—Ç–∞ |
| `GET` | `/read-status/unread-counts/all` | –ü–æ–¥—Å—á–µ—Ç –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤ |
| `GET` | `/read-status/:chatId/new-messages` | –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ timestamp |
| `DELETE` | `/read-status/:chatId` | –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏ |
| `GET` | `/read-status/stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã |

### **–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å (React + TypeScript)**

#### **1. –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö**
```typescript
// src/types/WhatsAppTypes.ts
export interface ReadStatus {
    chatId: string;
    userId?: string;
    lastReadMessageId: string;
    lastReadTimestamp: string;
    updatedAt: string;
}

export interface UnreadCountsResponse {
    success: boolean;
    unreadCounts?: { [chatId: string]: number };
    message?: string;
    error?: string;
}
```

#### **2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**
```typescript
// src/components/WhatsAppConnect.tsx

// –ü–æ–º–µ—Ç–∫–∞ —á–∞—Ç–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
const markChatAsRead = async (chatId: string) => {
    const response = await axios.post(`/read-status/mark-read/${chatId}`);
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
const loadCorrectUnreadCounts = async () => {
    const response = await axios.get('/read-status/unread-counts/all');
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ UI
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –¥–ª—è —á–∞—Ç–∞
const getUnreadCountForChat = async (chatId: string): Promise<number> => {
    const response = await axios.get(`/read-status/${chatId}/unread-count`);
    return response.data.unreadCount || 0;
}
```

## üé¨ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WhatsApp –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. ‚úÖ **–ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–∞—Ç—ã** —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏
3. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è** –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ API
4. ‚úÖ **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è UI** —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö

```mermaid
sequenceDiagram
    participant U as User
    participant C as Client
    participant S as Server
    participant DB as ReadStatus.json
    
    U->>C: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    C->>S: GET /chats
    S->>C: –ß–∞—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ counts
    C->>S: GET /read-status/unread-counts/all
    S->>DB: –ó–∞–≥—Ä—É–∑–∫–∞ read —Å—Ç–∞—Ç—É—Å–æ–≤
    DB->>S: –°—Ç–∞—Ç—É—Å—ã –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏
    S->>S: –ü–æ–¥—Å—á–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö unread counts
    S->>C: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
    C->>U: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π UI —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —á–∞—Ç –≤ —Å–ø–∏—Å–∫–µ
2. ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ** —Å—á–µ—Ç—á–∏–∫ –æ–±–Ω—É–ª—è–µ—Ç—Å—è –≤ UI
3. ‚úÖ **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å** –Ω–∞ —Å–µ—Ä–≤–µ—Ä –æ –ø—Ä–æ—á—Ç–µ–Ω–∏–∏
4. ‚úÖ **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```typescript
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —á–∞—Ç—É
setActiveChat={(chatId) => {
    setActiveChat(chatId);
    resetUnreadCount(chatId); // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ + API –≤—ã–∑–æ–≤
}}
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è**
1. –ü—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞
2. ‚úÖ **–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —á–∞—Ç** –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
3. ‚úÖ **–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—á–µ—Ç—á–∏–∫** —á–µ—Ä–µ–∑ API
4. ‚úÖ **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è UI** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º

```typescript
// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
if (!message.fromMe && phoneNumber !== activeChat) {
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ—Ä–µ–∑ API
    setTimeout(async () => {
        const correctUnreadCount = await getUnreadCountForChat(phoneNumber);
        updateChatUnreadCount(phoneNumber, correctUnreadCount);
    }, 100);
}
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 4: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–µ—Ä–Ω—É–ª—Å—è —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è
2. ‚úÖ **–°—Ç–∞—Ç—É—Å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω** –≤ –±–∞–∑–µ
3. ‚úÖ **–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è** —Ä–∞–Ω–µ–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
4. ‚úÖ **–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ** —Ä–µ–∞–ª—å–Ω–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

## üîÑ **–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã**

### **1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ**
```typescript
useEffect(() => {
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    loadChatsFromServer();
    
    // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
    setTimeout(() => {
        loadCorrectUnreadCounts();
    }, 500);
}, []);
```

### **2. –ü–æ–º–µ—Ç–∫–∞ —á–∞—Ç–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ**
```typescript
const resetUnreadCount = async (phoneNumber: string) => {
    // 1. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    setChats(prevChats => ({
        ...prevChats,
        [phoneNumber]: { ...prevChats[phoneNumber], unreadCount: 0 }
    }));
    
    // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    await markChatAsRead(phoneNumber);
};
```

### **3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π**
```typescript
const addMessageToChat = async (message: WhatsAppMessage) => {
    // 1. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    addMessageToUI(message);
    
    // 2. –ï—Å–ª–∏ –≤—Ö–æ–¥—è—â–µ–µ –∏ —á–∞—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω - –ø–æ–ª—É—á–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
    if (!message.fromMe && phoneNumber !== activeChat) {
        const correctCount = await getUnreadCountForChat(phoneNumber);
        updateUnreadCount(phoneNumber, correctCount);
    }
};
```

## üóÑÔ∏è **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö**

### **Read Status —Ñ–∞–π–ª (server/data/readStatus.json)**
```json
{
  "79001234567@c.us": {
    "chatId": "79001234567@c.us",
    "userId": null,
    "lastReadMessageId": "true_79001234567@c.us_3EB0123456789ABC_1",
    "lastReadTimestamp": "2024-01-15T14:30:00.000Z",
    "updatedAt": "2024-01-15T14:30:05.000Z"
  },
  "79007654321@c.us": {
    "chatId": "79007654321@c.us",
    "userId": null,
    "lastReadMessageId": "true_79007654321@c.us_3EB0987654321DEF_1",
    "lastReadTimestamp": "2024-01-14T16:45:30.000Z",
    "updatedAt": "2024-01-15T09:15:22.000Z"
  }
}
```

### **–õ–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö**
```typescript
const calculateUnreadCount = async (chatId: string): Promise<number> => {
    const readStatus = getReadStatus(chatId);
    const chat = getChat(chatId);
    
    if (!readStatus) {
        // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ - –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        return chat.messages.filter(msg => !msg.fromMe).length;
    }
    
    // –°—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
    const lastReadTime = new Date(readStatus.lastReadTimestamp).getTime();
    return chat.messages.filter(msg => {
        const messageTime = new Date(msg.timestamp).getTime();
        return !msg.fromMe && messageTime > lastReadTime;
    }).length;
};
```

## üìã **API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

### **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏**
```http
POST /read-status/update
Content-Type: application/json

{
  "chatId": "79001234567@c.us",
  "messageId": "msg_123456789",
  "timestamp": "2024-01-15T14:30:00.000Z",
  "userId": "user_123" // optional
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "readStatus": {
    "chatId": "79001234567@c.us",
    "lastReadMessageId": "msg_123456789",
    "lastReadTimestamp": "2024-01-15T14:30:00.000Z",
    "updatedAt": "2024-01-15T14:30:05.000Z"
  },
  "message": "–°—Ç–∞—Ç—É—Å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω"
}
```

### **–ü–æ–º–µ—Ç–∫–∞ —á–∞—Ç–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ**
```http
POST /read-status/mark-read/79001234567@c.us
Content-Type: application/json

{
  "userId": "user_123" // optional
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "readStatus": {
    "chatId": "79001234567@c.us",
    "lastReadMessageId": "msg_latest_id",
    "lastReadTimestamp": "2024-01-15T14:35:20.000Z",
    "updatedAt": "2024-01-15T14:35:25.000Z"
  },
  "message": "–ß–∞—Ç –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π"
}
```

### **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤**
```http
GET /read-status/unread-counts/all?userId=user_123
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "unreadCounts": {
    "79001234567@c.us": 3,
    "79007654321@c.us": 0,
    "79009876543@c.us": 7
  },
  "message": "–ü–æ–¥—Å—á–∏—Ç–∞–Ω—ã –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è 3 —á–∞—Ç–æ–≤"
}
```

### **–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è —á–∞—Ç–∞**
```http
GET /read-status/79001234567@c.us/unread-count?userId=user_123
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "chatId": "79001234567@c.us",
  "unreadCount": 3,
  "message": "–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ: 3"
}
```

## üé® **UI/UX –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**

### **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞**
```typescript
// –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–∞—Ç
const handleChatClick = (chatId: string) => {
    // 1. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
    setActiveChat(chatId);
    
    // 2. –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω—É–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    setChats(prev => ({
        ...prev,
        [chatId]: { ...prev[chatId], unreadCount: 0 }
    }));
    
    // 3. –í —Ñ–æ–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    markChatAsRead(chatId);
};
```

### **–ü–ª–∞–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤**
```css
/* –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ */
.unread-badge {
    transition: all 0.3s ease;
    transform: scale(1);
}

.unread-badge.updating {
    transform: scale(1.1);
    background-color: #10b981;
}

.unread-badge.zero {
    transform: scale(0);
    opacity: 0;
}
```

### **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è**
- üîµ **–°–∏–Ω–∏–π —Å—á–µ—Ç—á–∏–∫** - –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚≠ï **–ù–µ—Ç —Å—á–µ—Ç—á–∏–∫–∞** - –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω—ã
- üîÑ **–ê–Ω–∏–º–∞—Ü–∏—è** –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞
- ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ** –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞

## üöÄ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

### **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**
- **–ë–∞—Ç—á–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
- **–î–µ–±–∞—É–Ω—Å–∏–Ω–≥** - –∑–∞–¥–µ—Ä–∂–∫–∞ 100ms –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—á–µ—Ç—á–∏–∫–æ–≤
- **–ú–µ–º–æ–∏–∑–∞—Ü–∏—è** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–¥—Å—á–µ—Ç–∞
- **Lazy loading** - –∑–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```typescript
// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
const getReadStatusStats = () => ({
    totalStatuses: 150,
    recentStatuses: 142,
    oldStatuses: 8,
    memoryUsage: 24576,
    averageResponseTime: "12ms"
});
```

### **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
```typescript
// –ö—ç—à –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
const unreadCountCache = new Map<string, {
    count: number;
    timestamp: number;
    ttl: number; // 30 —Å–µ–∫—É–Ω–¥
}>();
```

## üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- **Graceful degradation** - –ø—Ä–∏ –æ—à–∏–±–∫–µ API –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
- **Retry logic** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
- **Fallback values** - –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- **Error boundaries** - –ø–µ—Ä–µ—Ö–≤–∞—Ç –æ—à–∏–±–æ–∫ –≤ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

### **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
```typescript
// –°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
if (!chatId || !messageId || !timestamp) {
    return res.status(400).json({
        success: false,
        error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å chatId, messageId –∏ timestamp'
    });
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è timestamp
if (isNaN(new Date(timestamp).getTime())) {
    return res.status(400).json({
        success: false,
        error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç timestamp'
    });
}
```

### **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å**
- **–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ù–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** - –≤—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- **–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- **User ID –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ

## üîÆ **–ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è**

### **–í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**
- [ ] **IndexedDB –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã
- [ ] **WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
- [ ] **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏** –ø—Ä–∏ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ
- [ ] **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á—Ç–µ–Ω–∏—è** - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ**
- [ ] **Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
- [ ] **Database –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è SQLite/PostgreSQL
- [ ] **API rate limiting** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- [ ] **Compressed responses** –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- [ ] **Background sync** –¥–ª—è PWA –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

## üí° **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–¥—Å—á–µ—Ç–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:

**–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
- üìñ **100% —Ç–æ—á–Ω–æ—Å—Ç—å** –ø–æ–¥—Å—á–µ—Ç–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
- üíæ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏** 
- ‚ö° **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** UI
- üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** —Å —Å–µ—Ä–≤–µ—Ä–æ–º
- üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞** —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- üì± **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- üé® **–ü–ª–∞–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏** –∏ –æ—Ç–ª–∏—á–Ω—ã–π UX

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ —Ç–æ—á–Ω–æ, –∫–∞–∫ –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º WhatsApp! 